#!/bin/sh

# Disable ISP DNS on WAN
uci set network.wan.peerdns='0'
uci delete network.wan.dns
uci commit network

# Configure DNSMasq
uci set dhcp.@dnsmasq[0]=dnsmasq
uci set dhcp.@dnsmasq[0].noresolv='1'
uci set dhcp.@dnsmasq[0].localuse='1'
uci set dhcp.@dnsmasq[0].cachesize='10000'
uci set dhcp.@dnsmasq[0].rebind_protection='0'  # Required for Iranian CDNs
uci set dhcp.@dnsmasq[0].strictorder='1'  # Try servers in order
uci set dhcp.@dnsmasq[0].allservers='1'   # Enable fallback
uci set dhcp.@dnsmasq[0].confdir='/etc/dnsmasq.d'
uci set dhcp.@dnsmasq[0].cachelocal='1'  # Cache local domains

# Create config directory
mkdir -p /etc/dnsmasq.d

# Iranian DNS Configuration (Shecan)
cat << "EOF" > /etc/dnsmasq.d/iran-domains.conf
# Primary Iranian DNS
server=/.ir/178.22.122.100
server=/.co.ir/178.22.122.100
server=/.ac.ir/178.22.122.100
server=/.gov.ir/178.22.122.100
server=/.org.ir/178.22.122.100
server=/.net.ir/178.22.122.100
server=/.sch.ir/178.22.122.100
server=/mci.ir/178.22.122.100
server=/mtnirancell.ir/178.22.122.100
server=/shatel.ir/178.22.122.100
server=/irancell.ir/178.22.122.100
server=/hamrahcard.ir/178.22.122.100
server=/rightel.ir/178.22.122.100
server=/mellatbank.com/178.22.122.100
server=/samanbank.com/178.22.122.100
server=/parsian-bank.com/178.22.122.100
server=/bankmaskan.ir/178.22.122.100
server=/bmi.ir/178.22.122.100
server=/sb24.com/178.22.122.100
server=/enbank.net/178.22.122.100
server=/digikala.com/178.22.122.100
server=/snapp.ir/178.22.122.100
server=/divar.ir/178.22.122.100
server=/tapsi.ir/178.22.122.100
server=/alibaba.ir/178.22.122.100
server=/torob.com/178.22.122.100

# Backup Iranian DNS
server=/ir/185.51.200.2
server=/co.ir/185.51.200.2
server=/ac.ir/185.51.200.2
server=/gov.ir/185.51.200.2
server=/org.ir/185.51.200.2
server=/net.ir/185.51.200.2
server=/sch.ir/185.51.200.2
EOF

# Global DNS Configuration with Proxy Priority
cat << "EOF" > /etc/dnsmasq.d/global-dns.conf
# First try PassWall2 DNS proxy
server=/#/127.0.0.1#7913

# Fallback to global DNS when proxy is disabled
server=/#/8.8.8.8
server=/#/8.8.4.4
server=/#/1.1.1.1
server=/#/1.0.0.1
EOF

# Configure DHCP
uci set dhcp.lan.dhcp_option='6,192.168.1.1'  # Router as DNS

# Configure PassWall2 with enhanced caching
uci set passwall2.@global[0].dns_mode='fakeip'
uci set passwall2.@global[0].dns_proxy_mode='udp'
uci set passwall2.@global[0].dns_listen='127.0.0.1'
uci set passwall2.@global[0].dns_server='8.8.8.8'
uci set passwall2.@global[0].dns_cache='1'
uci set passwall2.@global[0].dns_cache_timeout='3600'  # 1-hour caching
uci set passwall2.@global[0].dns_max_cache='5000'     # 5000 entries
uci set passwall2.@global[0].remote_dns='8.8.8.8'
uci set passwall2.@global[0].dns_query_strategy='prefer_ipv4'
uci set passwall2.@global[0].dns_fakeip_range='192.168.3.0/24'
uci set passwall2.@global[0].dns_auto='1'

# Enable DNS prefetching for better performance
uci set passwall2.@global[0].dns_prefetch='1'

# Apply changes
uci commit dhcp
uci commit passwall2

# Restart services
/etc/init.d/dnsmasq restart
/etc/init.d/network reload
/etc/init.d/passwall2 restart

echo "Optimized configuration applied!"
echo "DNS Mode: fakeip + UDP proxy with automatic routing"


---------------------------------------------------------------

# Force NTP resync
#uci delete system.ntp.server
#uci add_list system.ntp.server='ir.pool.ntp.org'
#uci add_list system.ntp.server='0.openwrt.pool.ntp.org'
##uci add_list system.ntp.server='1.openwrt.pool.ntp.org'
#uci commit system
#/etc/init.d/sysntpd restart

-----------------------------------------------------------------------------------

# Optional: Set default routing to proxy for all other traffic
uci set passwall2.default_policy='proxy'

# Optional: Split DNS resolvers
uci set passwall2.dns.direct_dns='178.22.122.100,185.51.200.2'
uci set passwall2.dns.proxy_dns='https://dns.google/dns-query'

# Optional: Force DNS hijack to prevent leaks
uci set passwall2.global.dns_mode='tun'
uci set passwall2.global.redirect_dns='1'

# Enable auto-update of geosite/geoip lists
uci set passwall2.auto_update='1'
uci set passwall2.auto_update_time='24'

# ===== DNS Leak Protection =====
uci set passwall2.@global[0].dns_mode='tun'  # Encrypted DNS tunnel
uci set passwall2.@global[0].remote_dns='tls://8.8.4.4'  # Google DNS over TLS
uci set passwall2.@global[0].remote_dns_ipv6='tls://2001:4860:4860::8844'  # Google IPv6
uci set passwall2.@global[0].dns_hijack='1'  # Force all DNS through proxy

# ===== Iranian Network Optimizations =====
uci set passwall2.@global[0].proxy_udp='1'  # UDP forwarding (VoIP/Video)
uci set passwall2.@global[0].buffer_size='65535'  # Bypass QoS throttling
uci set passwall2.@global[0].fast_open='1'  # TCP Fast Open (reduces latency)

# Iranian domains use local DNS
uci set passwall2.@domain_forward[0]='domain_forward'
uci set passwall2.@domain_forward[0].domain='~ir,~mci.ir,~irancell.ir'
uci set passwall2.@domain_forward[0].dns='178.22.122.100'  # Shecan DNS

# ===== Core Forwarding Rules =====
uci set passwall2.@global_forwarding[0]=global_forwarding
uci set passwall2.@global_forwarding[0].tcp_no_redir_ports='disable'
uci set passwall2.@global_forwarding[0].udp_no_redir_ports='disable'
uci set passwall2.@global_forwarding[0].tcp_redir_ports='1:65535'  # All TCP
uci set passwall2.@global_forwarding[0].udp_redir_ports='1:65535'  # All UDP

# ===== DNS Leak Protection =====
uci set passwall2.@global[0].dns_mode='tun'  # Encrypted DNS tunnel
uci set passwall2.@global[0].remote_dns='tls://8.8.4.4'  # Google DNS over TLS
uci set passwall2.@global[0].remote_dns_ipv6='tls://2001:4860:4860::8844'  # Google IPv6
uci set passwall2.@global[0].dns_hijack='1'  # Force all DNS through proxy

# ===== Iranian Network Optimizations =====
uci set passwall2.@global[0].proxy_udp='1'  # UDP forwarding (VoIP/Video)
uci set passwall2.@global[0].buffer_size='65535'  # Bypass QoS throttling
uci set passwall2.@global[0].fast_open='1'  # TCP Fast Open (reduces latency)

# Iranian domains use local DNS
uci set passwall2.@domain_forward[0]='domain_forward'
uci set passwall2.@domain_forward[0].domain='~ir,~mci.ir,~irancell.ir'
uci set passwall2.@domain_forward[0].dns='178.22.122.100'  # Shecan DNS

# Force WireGuard/UDP-based protocols (less throttled than TCP)
uci set passwall2.@global[0].tcp_proxy_mode='wireguard'  
uci set passwall2.@global[0].udp_proxy_mode='wireguard'

# Bypass QoS via packet manipulation
uci set passwall2.@global[0].mtu='1280'               # Mimics standard UDP traffic
uci set passwall2.@global[0].ttl='65'                  # Avoids "TTL filtering" traps

# Enable multi-path proxy (circumvents single-route blocking)
uci set passwall2.@global[0].proxy_multiplex='1'

# Obfuscation settings (critical for SNI-based blocking)
uci set passwall2.@global[0].tls_padding='1'           # Hides TLS handshake patterns
uci set passwall2.@global[0].tls_fingerprint='chrome'  # Mimics Chrome traffic

# Randomize packet characteristics
uci set passwall2.@global[0].packet_mark='0x1'         # Bypass route tracking
uci set passwall2.@global[0].fragment='1'              # Avoids packet length analysis

# Direct routing for Iranian services (reduces latency)
uci set passwall2.@bypass[0]='bypass'
uci set passwall2.@bypass[0].ip_list='geoip:ir'
uci set passwall2.@bypass[0].domain_list='geosite:ir 
    geosite:irancell 
    geosite:mci 
    full:snapp.ir 
    full:divar.ir 
    full:digikala.com'

# Auto-switch when blocking detected
uci set passwall2.@auto_switch[0]='auto_switch'
uci set passwall2.@auto_switch[0].enable='1'
uci set passwall2.@auto_switch[0].timeout='3'          # Faster failover
uci set passwall2.@auto_switch[0].url='https://cp.cloudflare.com'  # Test site

# Make proxy traffic resemble normal HTTPS
uci set passwall2.@global[0].tls_sni='cloudflare.com'  # Fake SNI
uci set passwall2.@global[0].tls_alpn='h2,http/1.1'    # Common ALPN patterns
uci set passwall2.@global[0].tls_utls='1'              # uTLS fingerprint spoofing

# Optimize for high-latency networks
uci set passwall2.@global[0].tcp_keep_alive='300'      # Persistent connections
uci set passwall2.@global[0].udp_timeout='60'         # Prevent UDP session drops

# Buffer management for throttled links
uci set passwall2.@global[0].send_buffer='2048000'
uci set passwall2.@global[0].receive_buffer='2048000'

# Force Xray-specific optimizations
uci set passwall2.@global[0].tcp_proxy_mode='xray'
uci set passwall2.@global[0].udp_proxy_mode='xray'

# Xray-core specific anti-censorship
uci set passwall2.@xray[0].transport='ws'              # WebSocket (bypasses DPI)
uci set passwall2.@xray[0].ws_host='www.speedtest.net' # Camouflage as speedtest
uci set passwall2.@xray[0].ws_path='/api/v1'          # Mimic API traffic

# Reality protocol settings (hardest to block)
uci set passwall2.@xray[0].reality='1'
uci set passwall2.@xray[0].reality_public_key='YOUR_PUB_KEY'
uci set passwall2.@xray[0].reality_short_id='12345678'
uci set passwall2.@xray[0].reality_server_name='cloudflare.com'

# Packet manipulation for throttled networks
uci set passwall2.@xray[0].tcp_fast_open='1'         # Reduce TCP handshakes
uci set passwall2.@xray[0].tcp_multi_path='1'        # Multi-route failover
uci set passwall2.@xray[0].udp_fragment='1'          # Bypass UDP QoS

# Timing adjustments for high-latency
uci set passwall2.@xray[0].tcp_keep_alive_interval='30'
uci set passwall2.@xray[0].udp_timeout='45'

# Enhanced DNS settings
uci set passwall2.@global[0].remote_dns='tls://8.8.4.4@853#dns.google'
uci set passwall2.@global[0].dns_query_strategy='UseIP'

# SNI obfuscation
uci set passwall2.@xray[0].sni='www.digikala.com'     # Fake Iranian SNI
uci set passwall2.@xray[0].fingerprint='chrome'       # Chrome fingerprint

# Iranian services direct routing
uci set passwall2.@bypass[0].ip_list='geoip:ir
    10.0.0.0/8
    172.16.0.0/12
    192.168.0.0/16'
    
uci set passwall2.@bypass[0].domain_list='geosite:ir
    geosite:irancell
    full:snapp.ir
    full:divar.ir
    regexp:^.+\.ir$'

# Auto-restart if blocked
uci set passwall2.@xray[0].health_check='1'
uci set passwall2.@xray[0].health_check_url='https://cp.cloudflare.com'
uci set passwall2.@xray[0].health_check_interval='60'

-------------------------------------------------------------------

#!/bin/sh
echo "=== Configuring Iran-Optimized PassWall2 Settings ==="

# System timezone
uci set system.@system[0].zonename='Asia/Tehran'
uci set system.@system[0].timezone='<+0330>-3:30'
uci commit system

# Global forwarding rules
uci -q delete passwall2.@global_forwarding[0]
uci add passwall2 global_forwarding
uci set passwall2.@global_forwarding[0].tcp_no_redir_ports='25,110,465,587,993,995'
uci set passwall2.@global_forwarding[0].udp_no_redir_ports='123,1194,51820'

# DNS settings
uci -q delete passwall2.@dns[0]
uci add passwall2 dns
uci set passwall2.@dns[0].enabled='1'
uci set passwall2.@dns[0].dns_mode='fake-dns'
uci set passwall2.@dns[0].dns_forward='8.8.8.8,1.1.1.1'
uci set passwall2.@dns[0].fallback_dns='178.22.122.100,185.51.200.2'
uci set passwall2.@dns[0].default_dns='local'
uci set passwall2.@dns[0].disable_ipv6='1'

# Iran and local IP bypass
uci -q delete passwall2.@access_control[0]
uci add passwall2 access_control
uci set passwall2.@access_control[0].direct_hosts='ir,iran.ir,ac.ir,bank.ir,shaparak.ir,dl.music-fa.com,dl.songsara.net'
uci set passwall2.@access_control[0].direct_ip='10.0.0.0/8,192.168.0.0/16,127.0.0.0/8'

# Auto-switch node config (use HTTP test)
uci -q delete passwall2.@auto_switch[0]
uci add passwall2 auto_switch
uci set passwall2.@auto_switch[0].enabled='1'
uci set passwall2.@auto_switch[0].testing_url='https://www.google.com/generate_204'
uci set passwall2.@auto_switch[0].timeout='5'
uci set passwall2.@auto_switch[0].try_count='2'
uci set passwall2.@auto_switch[0].node_timeout='5'
uci set passwall2.@auto_switch[0].connectivity_test_mode='http'

# Shunt rules for Iran websites and fallback
uci -q delete passwall2.@shunt_rules[0]
uci add passwall2 shunt_rules
uci set passwall2.@shunt_rules[-1].name='IR Sites'
uci set passwall2.@shunt_rules[-1].domain_list='ir,ac.ir,gov.ir,bank.ir,shaparak.ir,dl.music-fa.com'
uci set passwall2.@shunt_rules[-1].proxy_mode='direct'

uci -q delete passwall2.@shunt_rules[1]
uci add passwall2 shunt_rules
uci set passwall2.@shunt_rules[-1].name='Default'
uci set passwall2.@shunt_rules[-1].proxy_mode='default'

# Main shunt config (auto-pick node)
uci -q delete passwall2.@shunt[0]
uci add passwall2 shunt
uci set passwall2.@shunt[0].main_node='@auto_switch[0]'

# Commit all and restart
uci commit passwall2
/etc/init.d/passwall2 restart

echo "✅ Iran-optimized PassWall2 configuration applied."

------------------------------------------------------------------

#!/bin/sh
echo "=== ⚙️ Applying Full Iran-Specific PassWall2 Configuration ==="

# 1. Set timezone
uci set system.@system[0].zonename='Asia/Tehran'
uci set system.@system[0].timezone='<+0330>-3:30'
uci commit system

# 2. Global port exclusions (for compatibility)
uci -q delete passwall2.@global_forwarding[0]
uci add passwall2 global_forwarding
uci set passwall2.@global_forwarding[0].tcp_no_redir_ports='25,110,465,587,993,995'
uci set passwall2.@global_forwarding[0].udp_no_redir_ports='123,1194,51820'

# 3. DNS settings
uci -q delete passwall2.@dns[0]
uci add passwall2 dns
uci set passwall2.@dns[0].enabled='1'
uci set passwall2.@dns[0].dns_mode='fake-dns'
uci set passwall2.@dns[0].dns_forward='8.8.8.8,1.1.1.1'
uci set passwall2.@dns[0].fallback_dns='178.22.122.100,185.51.200.2'
uci set passwall2.@dns[0].default_dns='local'
uci set passwall2.@dns[0].disable_ipv6='1'

# 4. Local IP + Iran IP bypass
uci -q delete passwall2.@access_control[0]
uci add passwall2 access_control
uci set passwall2.@access_control[0].direct_hosts='ir,iran.ir,ac.ir,bank.ir,shaparak.ir,dl.music-fa.com,dl.songsara.net'
uci set passwall2.@access_control[0].direct_ip='10.0.0.0/8,192.168.0.0/16,127.0.0.0/8'

# 5. Auto-switch (test via HTTP, fast failover)
uci -q delete passwall2.@auto_switch[0]
uci add passwall2 auto_switch
uci set passwall2.@auto_switch[0].enabled='1'
uci set passwall2.@auto_switch[0].testing_url='https://www.google.com/generate_204'
uci set passwall2.@auto_switch[0].timeout='5'
uci set passwall2.@auto_switch[0].try_count='2'
uci set passwall2.@auto_switch[0].node_timeout='5'
uci set passwall2.@auto_switch[0].connectivity_test_mode='http'

# 6. Shunt rules
uci -q delete passwall2.@shunt_rules[0]
uci add passwall2 shunt_rules
uci set passwall2.@shunt_rules[-1].name='IR Sites'
uci set passwall2.@shunt_rules[-1].domain_list='ir,ac.ir,gov.ir,bank.ir,shaparak.ir,dl.music-fa.com,telegram.org,cdn.telegram.org,core.telegram.org'
uci set passwall2.@shunt_rules[-1].proxy_mode='direct'

uci -q delete passwall2.@shunt_rules[1]
uci add passwall2 shunt_rules
uci set passwall2.@shunt_rules[-1].name='Default'
uci set passwall2.@shunt_rules[-1].proxy_mode='default'

uci -q delete passwall2.@shunt[0]
uci add passwall2 shunt
uci set passwall2.@shunt[0].main_node='@auto_switch[0]'

# 7. Kill switch rule: Drop WAN traffic if tunnel fails
uci -q delete firewall.passwall2_killswitch
uci set firewall.passwall2_killswitch=rule
uci set firewall.passwall2_killswitch.name='KillSwitch'
uci set firewall.passwall2_killswitch.src='wan'
uci set firewall.passwall2_killswitch.dest='*'
uci set firewall.passwall2_killswitch.proto='all'
uci set firewall.passwall2_killswitch.target='DROP'
uci set firewall.passwall2_killswitch.enabled='1'

# 8. Block IRGC ASNs (basic ranges)
uci -q delete firewall.irgc_block
uci set firewall.irgc_block=rule
uci set firewall.irgc_block.name='Block IRGC ASN'
uci set firewall.irgc_block.src='lan'
uci set firewall.irgc_block.dest='wan'
uci set firewall.irgc_block.dest_ip='185.147.160.0/22 185.173.104.0/22 185.49.104.0/22'
uci set firewall.irgc_block.proto='all'
uci set firewall.irgc_block.target='REJECT'

# 9. Auto-load subscription (optional: edit to include your real sub link)
uci -q delete passwall2.@subscribe[0]
uci add passwall2 subscribe
uci set passwall2.@subscribe[0].enabled='1'
uci set passwall2.@subscribe[0].name='iran_secure'
uci set passwall2.@subscribe[0].url='https://your-obfuscated-subscription-url.example.com/iran.txt'
uci set passwall2.@subscribe[0].udp_quic='1'
uci set passwall2.@subscribe[0].auto_update_time='6'
uci set passwall2.@subscribe[0].use_proxy='0'

# 10. Boot persistence
uci -q delete system.@system[0].startup
uci set system.@system[0].startup='/etc/init.d/passwall2 restart'

# Save and apply
uci commit
/etc/init.d/firewall restart
/etc/init.d/passwall2 restart

echo "✅ All configurations applied successfully."


