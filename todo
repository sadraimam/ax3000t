# Optional: Set default routing to proxy for all other traffic
uci set passwall2.default_policy='proxy'

# Optional: Split DNS resolvers
uci set passwall2.dns.direct_dns='178.22.122.100,185.51.200.2'
uci set passwall2.dns.proxy_dns='https://dns.google/dns-query'

# Optional: Force DNS hijack to prevent leaks
uci set passwall2.global.dns_mode='tun'
uci set passwall2.global.redirect_dns='1'

# Enable auto-update of geosite/geoip lists
uci set passwall2.auto_update='1'
uci set passwall2.auto_update_time='24'

# ===== DNS Leak Protection =====
uci set passwall2.@global[0].dns_mode='tun'  # Encrypted DNS tunnel
uci set passwall2.@global[0].remote_dns='tls://8.8.4.4'  # Google DNS over TLS
uci set passwall2.@global[0].remote_dns_ipv6='tls://2001:4860:4860::8844'  # Google IPv6
uci set passwall2.@global[0].dns_hijack='1'  # Force all DNS through proxy

# ===== Iranian Network Optimizations =====
uci set passwall2.@global[0].proxy_udp='1'  # UDP forwarding (VoIP/Video)
uci set passwall2.@global[0].buffer_size='65535'  # Bypass QoS throttling
uci set passwall2.@global[0].fast_open='1'  # TCP Fast Open (reduces latency)

# Iranian domains use local DNS
uci set passwall2.@domain_forward[0]='domain_forward'
uci set passwall2.@domain_forward[0].domain='~ir,~mci.ir,~irancell.ir'
uci set passwall2.@domain_forward[0].dns='178.22.122.100'  # Shecan DNS

# ===== Core Forwarding Rules =====
uci set passwall2.@global_forwarding[0]=global_forwarding
uci set passwall2.@global_forwarding[0].tcp_no_redir_ports='disable'
uci set passwall2.@global_forwarding[0].udp_no_redir_ports='disable'
uci set passwall2.@global_forwarding[0].tcp_redir_ports='1:65535'  # All TCP
uci set passwall2.@global_forwarding[0].udp_redir_ports='1:65535'  # All UDP




# Force WireGuard/UDP-based protocols (less throttled than TCP)
uci set passwall2.@global[0].tcp_proxy_mode='wireguard'  
uci set passwall2.@global[0].udp_proxy_mode='wireguard'

# Bypass QoS via packet manipulation
uci set passwall2.@global[0].mtu='1280'               # Mimics standard UDP traffic
uci set passwall2.@global[0].ttl='65'                  # Avoids "TTL filtering" traps

# Enable multi-path proxy (circumvents single-route blocking)
uci set passwall2.@global[0].proxy_multiplex='1'

# Obfuscation settings (critical for SNI-based blocking)
uci set passwall2.@global[0].tls_padding='1'           # Hides TLS handshake patterns
uci set passwall2.@global[0].tls_fingerprint='chrome'  # Mimics Chrome traffic

# Randomize packet characteristics
uci set passwall2.@global[0].packet_mark='0x1'         # Bypass route tracking
uci set passwall2.@global[0].fragment='1'              # Avoids packet length analysis

# Direct routing for Iranian services (reduces latency)
uci set passwall2.@bypass[0]='bypass'
uci set passwall2.@bypass[0].ip_list='geoip:ir'
uci set passwall2.@bypass[0].domain_list='geosite:ir 
    geosite:irancell 
    geosite:mci 
    full:snapp.ir 
    full:divar.ir 
    full:digikala.com'

# Auto-switch when blocking detected
uci set passwall2.@auto_switch[0]='auto_switch'
uci set passwall2.@auto_switch[0].enable='1'
uci set passwall2.@auto_switch[0].timeout='3'          # Faster failover
uci set passwall2.@auto_switch[0].url='https://cp.cloudflare.com'  # Test site

# Make proxy traffic resemble normal HTTPS
uci set passwall2.@global[0].tls_sni='cloudflare.com'  # Fake SNI
uci set passwall2.@global[0].tls_alpn='h2,http/1.1'    # Common ALPN patterns
uci set passwall2.@global[0].tls_utls='1'              # uTLS fingerprint spoofing

# Optimize for high-latency networks
uci set passwall2.@global[0].tcp_keep_alive='300'      # Persistent connections
uci set passwall2.@global[0].udp_timeout='60'         # Prevent UDP session drops

# Buffer management for throttled links
uci set passwall2.@global[0].send_buffer='2048000'
uci set passwall2.@global[0].receive_buffer='2048000'

# Force Xray-specific optimizations
uci set passwall2.@global[0].tcp_proxy_mode='xray'
uci set passwall2.@global[0].udp_proxy_mode='xray'

# Xray-core specific anti-censorship
uci set passwall2.@xray[0].transport='ws'              # WebSocket (bypasses DPI)
uci set passwall2.@xray[0].ws_host='www.speedtest.net' # Camouflage as speedtest
uci set passwall2.@xray[0].ws_path='/api/v1'          # Mimic API traffic

# Reality protocol settings (hardest to block)
uci set passwall2.@xray[0].reality='1'
uci set passwall2.@xray[0].reality_public_key='YOUR_PUB_KEY'
uci set passwall2.@xray[0].reality_short_id='12345678'
uci set passwall2.@xray[0].reality_server_name='cloudflare.com'

# Packet manipulation for throttled networks
uci set passwall2.@xray[0].tcp_fast_open='1'         # Reduce TCP handshakes
uci set passwall2.@xray[0].tcp_multi_path='1'        # Multi-route failover
uci set passwall2.@xray[0].udp_fragment='1'          # Bypass UDP QoS

# Timing adjustments for high-latency
uci set passwall2.@xray[0].tcp_keep_alive_interval='30'
uci set passwall2.@xray[0].udp_timeout='45'

# Enhanced DNS settings
uci set passwall2.@global[0].remote_dns='tls://8.8.4.4@853#dns.google'
uci set passwall2.@global[0].dns_query_strategy='UseIP'

# SNI obfuscation
uci set passwall2.@xray[0].sni='www.digikala.com'     # Fake Iranian SNI
uci set passwall2.@xray[0].fingerprint='chrome'       # Chrome fingerprint

# Iranian services direct routing
uci set passwall2.@bypass[0].ip_list='geoip:ir
    10.0.0.0/8
    172.16.0.0/12
    192.168.0.0/16'
    
uci set passwall2.@bypass[0].domain_list='geosite:ir
    geosite:irancell
    full:snapp.ir
    full:divar.ir
    regexp:^.+\.ir$'

# Auto-restart if blocked
uci set passwall2.@xray[0].health_check='1'
uci set passwall2.@xray[0].health_check_url='https://cp.cloudflare.com'
uci set passwall2.@xray[0].health_check_interval='60'
